[SERVICE]
    Daemon              off
    Flush               1
    Log_Level           info
    Parsers_File        parsers.conf
    HTTP_Server         On
    HTTP_Listen         0.0.0.0
    HTTP_Port           2020
    Health_Check        On

# Docker 컨테이너 로그 수집 (Tail 방식)
# Docker는 /var/lib/docker/containers/<container-id>/<container-id>-json.log에 로그 저장
[INPUT]
    Name                tail
    Path                /var/lib/docker/containers/*/*.log
    Parser              docker
    Tag                 docker.*
    Refresh_Interval    5
    Mem_Buf_Limit       5MB
    Skip_Long_Lines     On
    DB                  /var/log/flb-docker.db
    DB.Sync             Normal

# [FILTER]
#     Name   grep
#     Match  docker.*
#     # container_name 필드 값에 backend 또는 mongodb 문자열이 포함된 것만 허용
#     # Docker가 container_name을 "/week14_backend" 형태로 줄 수도 있으니 .*을 사용
#     Regex  container_name (backend|mong)

# Docker 로그 JSON 파싱
[FILTER]
    Name                parser
    Match               docker.*
    Key_Name            log
    Parser              json
    Reserve_Data        On
    Preserve_Key        Off

# 필수 필드 추가
[FILTER]
    Name                modify
    Match               docker.*
    Add                 type log
    Add                 service_name week14-backend
    Add                 environment dev

# 외부 Producer 서버로 전송 (HTTP)
# 환경변수: PRODUCER_HOST, PRODUCER_PORT
[OUTPUT]
    Name                http
    Match               *
    Host                ${PRODUCER_HOST}
    Port                ${PRODUCER_PORT}
    URI                 /producer/logs
    Format              json
    Json_date_key       timestamp
    Json_date_format    iso8601
    Retry_Limit         3
    tls                 Off

# 디버깅용 stdout
[OUTPUT]
    Name                stdout
    Match               *
    Format              json_lines
